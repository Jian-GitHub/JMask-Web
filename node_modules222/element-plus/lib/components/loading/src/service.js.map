{"version":3,"file":"service.js","sources":["../../../../../../packages/components/loading/src/service.ts"],"sourcesContent":["import { nextTick } from 'vue'\nimport { isString } from '@vue/shared'\nimport { isClient } from '@vueuse/core'\nimport { addClass, getStyle, removeClass } from '@element-plus/utils/dom'\nimport PopupManager from '@element-plus/utils/popup-manager'\nimport { createLoadingComponent } from './loading'\nimport type { LoadingInstance } from './loading'\nimport type { LoadingOptionsResolved } from '..'\nimport type { LoadingOptions } from './types'\nimport type { CSSProperties } from 'vue'\n\nlet fullscreenInstance: LoadingInstance | undefined = undefined\n\nexport const Loading = function (\n  options: LoadingOptions = {}\n): LoadingInstance {\n  if (!isClient) return undefined as any\n\n  const resolved = resolveOptions(options)\n\n  if (resolved.fullscreen && fullscreenInstance) {\n    fullscreenInstance.close()\n  }\n\n  const instance = createLoadingComponent({\n    ...resolved,\n    closed: () => {\n      resolved.closed?.()\n      if (resolved.fullscreen) fullscreenInstance = undefined\n    },\n  })\n\n  addStyle(resolved, resolved.parent, instance)\n  addClassList(resolved, resolved.parent, instance)\n\n  resolved.parent.vLoadingAddClassList = () =>\n    addClassList(resolved, resolved.parent, instance)\n\n  /**\n   * add loading-number to parent.\n   * because if a fullscreen loading is triggered when somewhere\n   * a v-loading.body was triggered before and it's parent is\n   * document.body which with a margin , the fullscreen loading's\n   * destroySelf function will remove 'el-loading-parent--relative',\n   * and then the position of v-loading.body will be error.\n   */\n  let loadingNumber: string | null =\n    resolved.parent.getAttribute('loading-number')\n  if (!loadingNumber) {\n    loadingNumber = '1'\n  } else {\n    loadingNumber = `${Number.parseInt(loadingNumber) + 1}`\n  }\n  resolved.parent.setAttribute('loading-number', loadingNumber)\n\n  resolved.parent.appendChild(instance.$el)\n\n  // after instance render, then modify visible to trigger transition\n  nextTick(() => (instance.visible.value = resolved.visible))\n\n  if (resolved.fullscreen) {\n    fullscreenInstance = instance\n  }\n  return instance\n}\n\nconst resolveOptions = (options: LoadingOptions): LoadingOptionsResolved => {\n  let target: HTMLElement\n  if (isString(options.target)) {\n    target =\n      document.querySelector<HTMLElement>(options.target) ?? document.body\n  } else {\n    target = options.target || document.body\n  }\n  return {\n    parent: target === document.body || options.body ? document.body : target,\n    background: options.background || '',\n    svg: options.svg || '',\n    svgViewBox: options.svgViewBox || '',\n    spinner: options.spinner || false,\n    text: options.text || '',\n    fullscreen: target === document.body && (options.fullscreen ?? true),\n    lock: options.lock ?? false,\n    customClass: options.customClass || '',\n    visible: options.visible ?? true,\n    target,\n  }\n}\n\nconst addStyle = async (\n  options: LoadingOptionsResolved,\n  parent: HTMLElement,\n  instance: LoadingInstance\n) => {\n  const maskStyle: CSSProperties = {}\n  if (options.fullscreen) {\n    instance.originalPosition.value = getStyle(document.body, 'position')\n    instance.originalOverflow.value = getStyle(document.body, 'overflow')\n    maskStyle.zIndex = PopupManager.nextZIndex()\n  } else if (options.parent === document.body) {\n    instance.originalPosition.value = getStyle(document.body, 'position')\n    /**\n     * await dom render when visible is true in init,\n     * because some component's height maybe 0.\n     * e.g. el-table.\n     */\n    await nextTick()\n    for (const property of ['top', 'left']) {\n      const scroll = property === 'top' ? 'scrollTop' : 'scrollLeft'\n      maskStyle[property] = `${\n        (options.target as HTMLElement).getBoundingClientRect()[property] +\n        document.body[scroll] +\n        document.documentElement[scroll] -\n        parseInt(getStyle(document.body, `margin-${property}`), 10)\n      }px`\n    }\n    for (const property of ['height', 'width']) {\n      maskStyle[property] = `${\n        (options.target as HTMLElement).getBoundingClientRect()[property]\n      }px`\n    }\n  } else {\n    instance.originalPosition.value = getStyle(parent, 'position')\n  }\n  for (const [key, value] of Object.entries(maskStyle)) {\n    instance.$el.style[key] = value\n  }\n}\n\nconst addClassList = (\n  options: LoadingOptions,\n  parent: HTMLElement,\n  instance: LoadingInstance\n) => {\n  if (\n    instance.originalPosition.value !== 'absolute' &&\n    instance.originalPosition.value !== 'fixed'\n  ) {\n    addClass(parent, 'el-loading-parent--relative')\n  } else {\n    removeClass(parent, 'el-loading-parent--relative')\n  }\n  if (options.fullscreen && options.lock) {\n    addClass(parent, 'el-loading-parent--hidden')\n  } else {\n    removeClass(parent, 'el-loading-parent--hidden')\n  }\n}\n"],"names":["isClient","createLoadingComponent","isString","getStyle","PopupManager","nextTick"],"mappings":";;;;;;;;;;;AAWA,IAAI,qBAAkD;MAEzC,UAAU,SACrB,UAA0B,IACT;AACjB,MAAI,CAACA;AAAU,WAAO;AAEtB,QAAM,WAAW,eAAe;AAEhC,MAAI,SAAS,cAAc,oBAAoB;AAC7C,uBAAmB;AAAA;AAGrB,QAAM,WAAWC,+BAAuB;AAAA,OACnC;AAAA,IACH,QAAQ,MAAM;AA1BlB;AA2BM,qBAAS,WAAT;AACA,UAAI,SAAS;AAAY,6BAAqB;AAAA;AAAA;AAIlD,WAAS,UAAU,SAAS,QAAQ;AACpC,eAAa,UAAU,SAAS,QAAQ;AAExC,WAAS,OAAO,uBAAuB,MACrC,aAAa,UAAU,SAAS,QAAQ;AAU1C,MAAI,gBACF,SAAS,OAAO,aAAa;AAC/B,MAAI,CAAC,eAAe;AAClB,oBAAgB;AAAA,SACX;AACL,oBAAgB,GAAG,OAAO,SAAS,iBAAiB;AAAA;AAEtD,WAAS,OAAO,aAAa,kBAAkB;AAE/C,WAAS,OAAO,YAAY,SAAS;AAGrC,eAAS,MAAO,SAAS,QAAQ,QAAQ,SAAS;AAElD,MAAI,SAAS,YAAY;AACvB,yBAAqB;AAAA;AAEvB,SAAO;AAAA;AAGT,MAAM,iBAAiB,CAAC,YAAoD;AAlE5E;AAmEE,MAAI;AACJ,MAAIC,gBAAS,QAAQ,SAAS;AAC5B,aACE,eAAS,cAA2B,QAAQ,YAA5C,YAAuD,SAAS;AAAA,SAC7D;AACL,aAAS,QAAQ,UAAU,SAAS;AAAA;AAEtC,SAAO;AAAA,IACL,QAAQ,WAAW,SAAS,QAAQ,QAAQ,OAAO,SAAS,OAAO;AAAA,IACnE,YAAY,QAAQ,cAAc;AAAA,IAClC,KAAK,QAAQ,OAAO;AAAA,IACpB,YAAY,QAAQ,cAAc;AAAA,IAClC,SAAS,QAAQ,WAAW;AAAA,IAC5B,MAAM,QAAQ,QAAQ;AAAA,IACtB,YAAY,WAAW,SAAS,uBAAiB,eAAR,YAAsB;AAAA,IAC/D,MAAM,cAAQ,SAAR,YAAgB;AAAA,IACtB,aAAa,QAAQ,eAAe;AAAA,IACpC,SAAS,cAAQ,YAAR,YAAmB;AAAA,IAC5B;AAAA;AAAA;AAIJ,MAAM,WAAW,OACf,SACA,QACA,aACG;AACH,QAAM,YAA2B;AACjC,MAAI,QAAQ,YAAY;AACtB,aAAS,iBAAiB,QAAQC,aAAS,SAAS,MAAM;AAC1D,aAAS,iBAAiB,QAAQA,aAAS,SAAS,MAAM;AAC1D,cAAU,SAASC,wBAAa;AAAA,aACvB,QAAQ,WAAW,SAAS,MAAM;AAC3C,aAAS,iBAAiB,QAAQD,aAAS,SAAS,MAAM;AAM1D,UAAME;AACN,eAAW,YAAY,CAAC,OAAO,SAAS;AACtC,YAAM,SAAS,aAAa,QAAQ,cAAc;AAClD,gBAAU,YAAY,GACnB,QAAQ,OAAuB,wBAAwB,YACxD,SAAS,KAAK,UACd,SAAS,gBAAgB,UACzB,SAASF,aAAS,SAAS,MAAM,UAAU,aAAa;AAAA;AAG5D,eAAW,YAAY,CAAC,UAAU,UAAU;AAC1C,gBAAU,YAAY,GACnB,QAAQ,OAAuB,wBAAwB;AAAA;AAAA,SAGvD;AACL,aAAS,iBAAiB,QAAQA,aAAS,QAAQ;AAAA;AAErD,aAAW,CAAC,KAAK,UAAU,OAAO,QAAQ,YAAY;AACpD,aAAS,IAAI,MAAM,OAAO;AAAA;AAAA;AAI9B,MAAM,eAAe,CACnB,SACA,QACA,aACG;AACH,MACE,SAAS,iBAAiB,UAAU,cACpC,SAAS,iBAAiB,UAAU,SACpC;AACA,iBAAS,QAAQ;AAAA,SACZ;AACL,oBAAY,QAAQ;AAAA;AAEtB,MAAI,QAAQ,cAAc,QAAQ,MAAM;AACtC,iBAAS,QAAQ;AAAA,SACZ;AACL,oBAAY,QAAQ;AAAA;AAAA;;;;"}